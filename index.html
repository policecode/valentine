<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>üíñ Valentine's Surprise</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --glow: #ff69b4;
        --brand: #ff2c2c;
        --glow: #ffb6c1; /* M√†u h·ªìng nh·∫°t cho hi·ªáu ·ª©ng t·ªèa s√°ng */
        --brand: #e63946; /* M√†u ƒë·ªè Valentine ch·ªß ƒë·∫°o */
        --ribbon-color: #fcefb4; /* M√†u v√†ng kem/v√†ng h·ªìng cho ruy bƒÉng */
        --box-shadow: #8b0000;
      }
      * {
        box-sizing: border-box;
        font-family: "Dancing Script", cursive;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        overflow: hidden;
        color: #fff;
        font-family: "Plus Jakarta Sans", system-ui;
        background: radial-gradient(circle at center, #4a0e0e 0%, #1a0505 100%);
      }
      #space {
        position: fixed;
        inset: 0;
        z-index: -3;
      }

      /* ===== Gift box ===== */
      .stage {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        z-index: 1100;
      }
      .gift {
        position: relative;
        width: 280px;
        height: 240px;
        cursor: pointer;
        transform-style: preserve-3d;
        perspective: 1200px;
        filter: drop-shadow(0 14px 28px #0007);
        transition: transform 0.6s cubic-bezier(0.2, 0.9, 0.2, 1);
        z-index: 1200;
      }
      .gift:hover {
        transform: translateY(-6px) rotateX(3deg) rotateY(-2deg);
      }
      .box,
      .lid {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
      }
      .box {
        bottom: 0;
        height: 66%;
        border-radius: 20px;
        /* Hi·ªáu ·ª©ng ƒë·ªè nhung s√¢u h∆°n */
        background: linear-gradient(180deg, #ff4d4d, #c31432 65%, #8b0000);
        box-shadow:
          inset 0 0 0 1px #5e0b0b,
          inset 0 -10px 30px #0006,
          0 12px 40px #0008;
      }
      .ribbon-v,
      .ribbon-h {
        position: absolute;
        /* ƒê·ªïi t·ª´ tr·∫Øng sang v√†ng kem/v√†ng h·ªìng */
        background: linear-gradient(180deg, #fcefb4, #f8d48a);
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
      }
      .ribbon-v {
        width: 24px;
        left: calc(50% - 12px);
        top: 0;
        height: 100%;
        border-radius: 10px;
      }
      .ribbon-h {
        height: 20px;
        width: 100%;
        top: 44%;
        left: 0;
      }
      .lid {
        top: 0;
        height: 30%;
        transform-origin: 50% 100%;
        border-radius: 20px 20px 12px 12px;
        background: linear-gradient(180deg, #ff5e5e, #d4143a 70%, #a00b28);
        box-shadow:
          inset 0 0 0 1px #7b0808,
          0 10px 20px #0009;
        transition: transform 0.9s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .lid::after {
        content: "";
        position: absolute;
        left: 6%;
        right: 6%;
        bottom: -5px;
        height: 8px;
        border-radius: 0 0 10px 10px;
        background: linear-gradient(180deg, #b90b0b, #7a0707);
        box-shadow: 0 5px 10px #0008;
      }
      .lid .ribbon-v {
        height: 100%;
        border-radius: 10px;
      }
      .bow {
        position: absolute;
        top: -2px;
        left: 50%;
        transform: translateX(-50%);
        width: 120px;
        height: 56px;
      }
      .bow .loop {
        position: absolute;
        top: 6px;
        width: 56px;
        height: 36px;
        border-radius: 40px 40px 14px 14px;
        /* Thay ƒë·ªïi t·ª´ m√†u xanh sang m√†u h·ªìng/ƒë·ªè ƒë·ªìng b·ªô */
        background: linear-gradient(180deg, #ffb6c1 0%, #ff4d6d 80%);
        box-shadow:
          0 6px 12px #0004,
          inset 0 -6px 10px #c9184a;
      }
      .bow .loop.left {
        left: 0;
        transform: rotate(-10deg);
      }
      .bow .loop.right {
        right: 0;
        transform: rotate(10deg);
      }
      .bow .knot {
        position: absolute;
        left: 50%;
        top: 16px;
        transform: translateX(-50%);
        width: 26px;
        height: 26px;
        border-radius: 50%;
        /* N√∫t th·∫Øt n∆° m√†u h·ªìng ƒë·∫≠m */
        background: linear-gradient(180deg, #ff8fa3, #ff4d6d);
        box-shadow:
          0 0 10px rgba(255, 77, 109, 0.5),
          inset 0 -6px 10px #a4133c;
      }

      .glow {
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        box-shadow:
          0 0 22px 4px var(--glow) inset,
          0 0 36px 14px var(--glow);
        opacity: 0;
        transition: opacity 0.6s;
      }
      .preflash {
        position: absolute;
        inset: -6px;
        border-radius: 22px;
        pointer-events: none;
        box-shadow:
          0 0 18px 8px rgba(255, 255, 255, 0.7) inset,
          0 0 70px 26px rgba(255, 255, 255, 0.55);
        filter: blur(0.3px);
        opacity: 0;
        transition: opacity 0.28s ease;
      }
      .opened .lid {
        transform: rotateX(60deg) translateY(-10px) scale(1.02);
      }
      .opened .glow {
        opacity: 0.8;
      }
      .spark {
        position: absolute;
        inset: -18%;
        pointer-events: none;
        opacity: 0;
      }
      .opened .spark {
        opacity: 1;
      }
      .hint {
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translate(-50%, 18px);
        color: #a7b3c4;
        font-weight: 600;
        animation: breathe 2.4s ease-in-out infinite;
        text-align: center;
        z-index: 1250;
      }
      .hint small {
        display: block;
        opacity: 0.8;
      }
      @keyframes breathe {
        0%,
        100% {
          opacity: 1;
          transform: translate(-50%, 18px);
        }
        50% {
          opacity: 0.5;
          transform: translate(-50%, 22px);
        }
      }

      #hbdWrap {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        pointer-events: none;
        z-index: 3000;
        opacity: 0;
      }
      .hbd-letter {
        display: inline-block;
        font-family: "Dancing Script", cursive;
        font-weight: 700;

        /* C·∫¨P NH·∫¨T ·ªû ƒê√ÇY: */
        /* S·ª≠ d·ª•ng h√†m clamp: T·ªëi thi·ªÉu 40px, ∆∞u ti√™n 10% chi·ªÅu r·ªông m√†n h√¨nh, t·ªëi ƒëa 96px */
        font-size: clamp(40px, 8vw, 80px);

        line-height: 1;
        background: linear-gradient(90deg, #ff4d4d, #ff9a9e, #fad0c4);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        text-shadow: 0 0 16px rgba(255, 255, 255, 0.35);
        filter: drop-shadow(0 6px 16px rgba(0, 0, 0, 0.35));
        transform: translateY(30px) scale(0.7) rotate(-6deg);
        opacity: 0;

        /* ƒê·∫£m b·∫£o ch·ªØ kh√¥ng b·ªã ng·∫Øt d√≤ng x·∫•u tr√™n ƒëi·ªán tho·∫°i qu√° nh·ªè */
        white-space: nowrap;
      }
      @keyframes letterPop {
        0% {
          opacity: 0;
          transform: translateY(30px) scale(0.7) rotate(-6deg);
        }
        60% {
          opacity: 1;
          transform: translateY(-6px) scale(1.05) rotate(2deg);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1) rotate(0);
        }
      }
      #fireworks {
        position: fixed;
        inset: 0;
        z-index: 950;
        pointer-events: none;
      }

      img.fly {
        position: absolute;
        object-fit: cover;
        border-radius: 18px;
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.25);
        box-shadow: 0 10px 34px #000a;
        transition:
          opacity 0.8s ease,
          transform 1.6s cubic-bezier(0.2, 0.8, 0.25, 1);
        z-index: 800;
        will-change: transform, opacity;
        pointer-events: none;
      }
      img.fly:hover {
        transform: translate(-50%, -50%) scale(1.03);
      }
      @keyframes calmFloat {
        0% {
          transform: translate(-50%, -50%) scale(1);
        }
        50% {
          transform: translate(-50%, -52%) scale(1.02);
        }
        100% {
          transform: translate(-50%, -50%) scale(1);
        }
      }
      img.fly.calm {
        animation: calmFloat 9s ease-in-out 2;
      }

      .ribbon-piece {
        position: fixed;
        width: 14px;
        height: 6px;
        border-radius: 3px;
        background: linear-gradient(90deg, #ff9de1, #ffd166);
        box-shadow: 0 0 10px rgba(255, 200, 220, 0.7);
        z-index: 960;
        pointer-events: none;
      }
      .banner {
        position: fixed;
        height: 10px;
        background: linear-gradient(#fff, #eee);
        border-radius: 6px;
        box-shadow: 0 2px 10px #0006;
        z-index: 960;
        pointer-events: none;
        transform-origin: left center;
        opacity: 0.95;
      }
      .ring {
        position: fixed;
        width: 10px;
        height: 10px;
        border: 3px solid rgba(255, 255, 255, 0.7);
        border-radius: 50%;
        z-index: 940;
        pointer-events: none;
        opacity: 0.9;
        transform: translate(-50%, -50%) scale(0.35);
        animation: ringPulse 1200ms ease-out forwards;
      }
      @keyframes ringPulse {
        to {
          transform: translate(-50%, -50%) scale(3.2);
          opacity: 0;
        }
      }

      .notice {
        position: fixed;
        bottom: 12px;
        right: 14px;
        font-size: 12px;
        color: #b9c4d1a8;
        user-select: none;
        z-index: 1000;
      }

      .flash {
        position: fixed;
        inset: 0;
        background: #fff;
        opacity: 0;
        z-index: 4000;
        pointer-events: none;
      }
      @keyframes flashAnim {
        0% {
          opacity: 0;
        }
        10% {
          opacity: 0.95;
        }
        100% {
          opacity: 0;
        }
      }
      .shock {
        position: fixed;
        left: 50%;
        top: 50%;
        width: 20px;
        height: 20px;
        border: 2px solid #fff;
        border-radius: 50%;
        transform: translate(-50%, -50%) scale(1);
        opacity: 0.85;
        z-index: 3999;
        pointer-events: none;
        animation: shock 1500ms ease-out forwards;
      }
      @keyframes shock {
        to {
          transform: translate(-50%, -50%) scale(50);
          opacity: 0;
        }
      }
      .frag {
        position: fixed;
        width: 16px;
        height: 12px;
        border-radius: 3px;
        z-index: 3980;
        pointer-events: none;
        background: linear-gradient(180deg, #ff3a3a, #a30a0a);
        box-shadow:
          0 6px 16px #000a,
          inset 0 -4px 8px #7b0808;
      }

      #letterOverlay {
        position: fixed;
        inset: 0;
        display: none;
        place-items: center;
        background: rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(2px);
        z-index: 4200;
      }
      .letter {
        width: min(720px, 92vw);
        background: #fff;
        color: #222;
        border-radius: 14px;
        box-shadow: 0 24px 90px rgba(0, 0, 0, 0.45);
        overflow: hidden;
        transform: translateY(20px) scale(0.98);
        opacity: 0;
        font-family: ui-serif, Georgia, "Times New Roman", serif;
      }
      .letter-header {
        background: linear-gradient(90deg, #ff9de1, #ffd166, #9de2ff);
        height: 10px;
      }
      .letter-body {
        padding: 22px 20px 26px;
      }
      .letter-body h2 {
        margin: 6px 0 10px;
        font-family: "Great Vibes", cursive;
        font-size: 40px;
        color: #c2185b;
      }
      .letter-body p {
        font-size: 18px;
        line-height: 1.65;
        margin: 10px 0;
      }
      .letter-close {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-top: 14px;
        border: 0;
        background: #111;
        color: #fff;
        font-weight: 700;
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
      }
      @media (max-width: 600px) {
        .hbd-letter {
          /* Gi·∫£m b√≥ng ƒë·ªï m·ªôt ch√∫t ƒë·ªÉ ch·ªØ tr√¥ng s·∫Øc n√©t h∆°n tr√™n m√†n h√¨nh nh·ªè */
          filter: drop-shadow(0 3px 8px rgba(0, 0, 0, 0.35));
          text-shadow: 0 0 8px rgba(255, 255, 255, 0.25);
        }
      }
    </style>
  </head>
  <body>
    <audio id="bgMusic" loop>
      <source src="./Beautiful Things.mp3" type="audio/mpeg" />
    </audio>

    <div
      id="musicBtn"
      style="
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 5000;
        cursor: pointer;
        font-size: 24px;
        opacity: 0.6;
      "
    >
      <span id="musicIcon">üîá</span>
    </div>
    <canvas id="space"></canvas>

    <div id="hbdWrap" aria-hidden="true"></div>
    <canvas id="fireworks"></canvas>

    <main class="stage">
      <div class="gift" id="gift" aria-label="M·ªü h·ªôp qu√†">
        <div class="lid">
          <div class="ribbon-v"></div>
          <div class="bow">
            <div class="loop left"></div>
            <div class="loop right"></div>
            <div class="knot"></div>
          </div>
        </div>
        <div class="box">
          <div class="ribbon-v"></div>
          <div class="ribbon-h"></div>
          <div class="glow"></div>
          <div class="preflash" id="preflash"></div>
        </div>
        <canvas class="spark" id="spark" width="600" height="600"></canvas>
        <div class="hint">
          üíù M·ªôt m√≥n qu√† cho Valentine...<br />
          <small id="remainTxt">Ch·∫°m v√†o ƒë·ªÉ kh√°m ph√° t√¨nh y√™u ‚ú®</small>
        </div>
      </div>
    </main>

    <!-- L√° th∆∞ -->
    <div id="letterOverlay">
      <div class="letter" id="letter">
        <div class="letter-header"></div>
        <div class="letter-body" id="letterContent">
          <h2>G·ª≠i Mrs. Th·∫£o üåπ</h2>
          <p>Ch√∫c em m·ªôt ng√†y 14/2 th·∫≠t vui v√† ng·ªçt ng√†o nh√©.</p>
          <p>
            D√π h√¥m nay c√≥ nh·∫≠n ƒë∆∞·ª£c bao nhi√™u qu√† hay l·ªùi ch√∫c ƒëi n·ªØa, anh v·∫´n mong em nh·ªõ r·∫±ng em lu√¥n l√† m·ªôt c√¥ g√°i r·∫•t d·ªÖ th∆∞∆°ng v√† ƒë√°ng ƒë∆∞·ª£c tr√¢n tr·ªçng.
          </p>
          <p>
            Ch√∫c em lu√¥n h·∫°nh ph√∫c v√† l√∫c n√†o c≈©ng r·∫°ng r·ª° nh∆∞ c√°ch em v·∫´n v·∫≠y nh√© üíõ
          </p>

          <button class="letter-close" id="closeLetter">
            C√°i n√†y th√∫ v·ªã ch·ª©! ƒê√≥ng th∆∞ l·∫°i nh√© ‚ù§Ô∏è
          </button>
        </div>
      </div>
    </div>

    <div class="notice" id="notice"></div>

    <script>
      const bgMusic = document.getElementById("bgMusic");
      const musicBtn = document.getElementById("musicBtn");
      const musicIcon = document.getElementById("musicIcon");
      let isMusicPlaying = false;

      // H√†m b·∫≠t/t·∫Øt nh·∫°c
      function toggleMusic() {
        if (isMusicPlaying) {
          bgMusic.pause();
          musicIcon.textContent = "üîá";
        } else {
          bgMusic.volume = 0.5;
          bgMusic.play();
          musicIcon.textContent = "üîä";
        }
        isMusicPlaying = !isMusicPlaying;
      }
      musicBtn.addEventListener("click", toggleMusic);
      (function () {
        const canvas = document.getElementById("space"),
          ctx = canvas.getContext("2d");
        const dpr = Math.min(devicePixelRatio || 1, 2);
        let W, H;

        function resize() {
          W = innerWidth;
          H = innerHeight;
          canvas.width = W * dpr;
          canvas.height = H * dpr;
          ctx.scale(dpr, dpr);
        }
        resize();
        addEventListener("resize", resize);

        // Kh·ªüi t·∫°o c√°c tr√°i tim tr√¥i n·ªïi
        const hearts = Array.from({ length: 40 }, () => ({
          x: Math.random() * W,
          y: Math.random() * H,
          size: Math.random() * 8 + 4,
          speed: Math.random() * 0.5 + 0.2,
          opacity: Math.random() * 0.5 + 0.2,
          angle: Math.random() * Math.PI * 2,
          sway: Math.random() * 2 + 1,
        }));

        // Kh·ªüi t·∫°o c√°c h·∫°t l·∫•p l√°nh (glitter)
        const sparkles = Array.from({ length: 80 }, () => ({
          x: Math.random() * W,
          y: Math.random() * H,
          r: Math.random() * 1.5,
          blink: Math.random() * 0.05,
        }));

        function drawHeartShape(x, y, size, color, opacity) {
          ctx.save();
          ctx.beginPath();
          ctx.translate(x, y);
          ctx.fillStyle = color;
          ctx.globalAlpha = opacity;
          for (let i = 0; i <= Math.PI * 2; i += 0.1) {
            const dx = (size / 1.5) * 16 * Math.pow(Math.sin(i), 3);
            const dy =
              -(size / 1.5) *
              (13 * Math.cos(i) -
                5 * Math.cos(2 * i) -
                2 * Math.cos(3 * i) -
                Math.cos(4 * i));
            if (i === 0) ctx.moveTo(dx, dy);
            else ctx.lineTo(dx, dy);
          }
          ctx.fill();
          ctx.restore();
        }

        function tick(t) {
          // T·∫°o hi·ªáu ·ª©ng m·ªù ·∫£o cho n·ªÅn
          ctx.clearRect(0, 0, W, H);

          // 1. V·∫Ω c√°c h·∫°t l·∫•p l√°nh
          sparkles.forEach((s) => {
            ctx.fillStyle = `rgba(255, 182, 193, ${0.3 + Math.sin(t * 0.002 + s.x) * 0.2})`;
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
            ctx.fill();
          });

          // 2. V·∫Ω v√† c·∫≠p nh·∫≠t v·ªã tr√≠ tr√°i tim
          hearts.forEach((h) => {
            h.y -= h.speed; // Tr√¥i l√™n tr√™n
            h.x += Math.sin(t * 0.001 + h.angle) * 0.5; // ƒêu ƒë∆∞a nh·∫π nh√†ng

            // N·∫øu tr√¥i ra kh·ªèi m√†n h√¨nh th√¨ xu·∫•t hi·ªán l·∫°i ·ªü d∆∞·ªõi
            if (h.y < -20) {
              h.y = H + 20;
              h.x = Math.random() * W;
            }

            drawHeartShape(h.x, h.y, h.size, "#ff4d6d", h.opacity);
          });

          // 3. Hi·ªáu ·ª©ng √°nh s√°ng huy·ªÅn ·∫£o ·ªü c√°c g√≥c
          const grad = ctx.createRadialGradient(
            W / 2,
            H / 2,
            0,
            W / 2,
            H / 2,
            W,
          );
          grad.addColorStop(0, "transparent");
          grad.addColorStop(1, "rgba(74, 14, 14, 0.4)");
          ctx.fillStyle = grad;
          ctx.fillRect(0, 0, W, H);

          requestAnimationFrame(tick);
        }
        tick(0);
      })();

      /* ===== Confetti ===== */
      function runConfetti(at, count = 70) {
        const colors = ["#8a7bff", "#22d3ee", "#ffd166", "#ff7d9b", "#51ffcd"];
        for (let i = 0; i < count; i++) {
          const el = document.createElement("div");
          el.style.cssText =
            "position:fixed;width:8px;height:8px;border-radius:2px;opacity:.95;z-index:980;";
          el.style.background = colors[i % colors.length];
          document.body.appendChild(el);
          const vx = (Math.random() - 0.5) * 12,
            vy = -Math.random() * 14 - 6,
            rot = Math.random() * 360;
          let t = 0;
          (function step() {
            t += 1;
            const x = at.x + vx * t,
              y = at.y + vy * t + 0.35 * t * t;
            el.style.transform = `translate(${x}px,${y}px) rotate(${rot + t * 10}deg)`;
            el.style.opacity = String(1 - t / 110);
            if (t < 110) requestAnimationFrame(step);
            else el.remove();
          })();
        }
      }

      /* ===== N·∫°p ·∫£nh ===== */
      async function loadUserImages() {
        const urls = [
          "https://scontent.fhan14-4.fna.fbcdn.net/v/t39.30808-6/631066540_2199209640830005_4326000490506101910_n.jpg?_nc_cat=102&ccb=1-7&_nc_sid=a5f93a&_nc_eui2=AeFfB83PPpo8fv8jq7IecrLeirOPxezKTO6Ks4_F7MpM7s0Qs3EbXKbAD7MfjA0Gy-qSVgSLpNO32C6rvnG_44pN&_nc_ohc=hphmT9-zVMAQ7kNvwEKPGDv&_nc_oc=AdkV2rDHmo6pL3gSVlBl7T7i8JZOM-LlGOiQ-NLYrrkbVbHvsSjRoGDmBNUgERNXRgp5XlCbafHZzgFSTy4_YA_p&_nc_zt=23&_nc_ht=scontent.fhan14-4.fna&_nc_gid=w57_ZudilYEDRN28zyjhfw&oh=00_AfvjF1pa8065c6nveD-n84DCILcVgrFc4xlNz8t9IRQj-A&oe=69954B42",
          "https://scontent.fhan14-5.fna.fbcdn.net/v/t39.30808-6/616437499_2180545759363060_2700153363256105773_n.jpg?_nc_cat=106&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeH5xHnA47PcdaEQnLhlbIq8EAPlggKb2ggQA-WCApvaCMITbWot9Hlu33n4IkE0o8__twGEBIiAyxnpH1d3gktq&_nc_ohc=iZa7jC70no4Q7kNvwHl5rI8&_nc_oc=AdkcKwqMoPcIcAtZTGaD3rld0KF2DMIqEI29ZSmZkbWQ6pg8fQgA6xz0P0VF2_RIYZnMl5AMnfemAdxAUVuVSp29&_nc_zt=23&_nc_ht=scontent.fhan14-5.fna&_nc_gid=iSwOXS7ww5FEKJ_-nIOuzA&oh=00_Afvid3ZlB6sZgfeD5Kg8d-Iba9kUUPI4njo3RDJAa0SZHg&oe=69952185",
          "https://scontent.fhan14-3.fna.fbcdn.net/v/t39.30808-6/598102912_2153395052078131_6051899181808114908_n.jpg?_nc_cat=110&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeE47mnZHwUh-gMvYxv6DiaWwnYDUU2KIoLCdgNRTYoigtLlepXxbyoBLtLTAJsb3UxSOIqsRpaW73mkgtFQ-DSP&_nc_ohc=xfknDh5Lc58Q7kNvwFAqhxw&_nc_oc=AdlWIj6bxU6_mKKR-rCbiyuHVjx64m-dws4rpJwn0xE0fvuev6GKf6Xa4moCNixP2k4sDDJ5EC8BQh2l97lZLc08&_nc_zt=23&_nc_ht=scontent.fhan14-3.fna&_nc_gid=qs8dSh_LW22XwUEPU-PWew&oh=00_AfsneufZMo74AQ8eVhhhdXBglO4I6ay-5a2YwSN4MOnDzg&oe=699543F7",
          "https://scontent.fhan14-4.fna.fbcdn.net/v/t39.30808-6/571326966_2114210909329879_3816049070945819673_n.jpg?_nc_cat=102&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeEJyQxmBPGdH46Rb-BTaxhk44Fa9HNyf4_jgVr0c3J_j_4CBTbUNPmdIDsuqEwtrAfPIp_ZDSGhseY51rqT_EWK&_nc_ohc=SxuiQBaMacwQ7kNvwE4Tjv3&_nc_oc=AdmcsPm1TuSJGzVw0OBgbeji14reY80GGc3PtUzQdwLRSZWVlb7P7fmRifC8ZRqiJdd6Jte7aR0sVtPanV7yaRae&_nc_zt=23&_nc_ht=scontent.fhan14-4.fna&_nc_gid=sQ5BbBJR7tfSxv3qhCvMYA&oh=00_AftxeiCg8MU9-2ZbDC8W3GpenuIbqIA2Jqym4uiWy0-qKg&oe=6995564C",
          "https://scontent.fhan14-2.fna.fbcdn.net/v/t39.30808-6/556104748_2085007908916846_2649099241435164604_n.jpg?_nc_cat=108&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeHNz9uO1Dtu-6pyCB4t2liROJuIbQXUf2g4m4htBdR_aHqbhd3pHl06S38x1SX05KzhWuHQZdktPHgPfPWEFCcF&_nc_ohc=t2eA6p2rHVoQ7kNvwFg4bXx&_nc_oc=AdmHZgPmetYmGLdCxYUNr6TpYV8jarvYp6-RLKDOzd_4Gort8cnpgSosQ7roEhEGm54qUwpMtCRSCyiVMX1MKn1u&_nc_zt=23&_nc_ht=scontent.fhan14-2.fna&_nc_gid=3Vj8jYxKQxpNYvEK3YFVCA&oh=00_AfstDdb7S6rNzJI-pYi-SLB6pSlloYXPy1nefQsuTWogpg&oe=6995266D",
          "https://scontent.fhan14-1.fna.fbcdn.net/v/t39.30808-6/542750153_2062556697828634_6804088129034011226_n.jpg?stp=cp6_dst-jpg_tt6&_nc_cat=105&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeExRQpvNgIezyBg_MFX7o3SVVM_vIAncGVVUz-8gCdwZfOkBg-5Plho8SBwVpyx_Oryp--8R5y2z-BH_7ktq-0G&_nc_ohc=RCEP-F_HQ9oQ7kNvwHYzu4G&_nc_oc=AdnQdi89fXf9o4cXisS7jbV-FIppJvwrezt6x0BFZsMoCXu0QsWmlgRSiO8qzjfM0LfHL4Z5neQ1m3sTJAjGy8CZ&_nc_zt=23&_nc_ht=scontent.fhan14-1.fna&_nc_gid=JK1NecUrZ-lakLrepU0vpQ&oh=00_AftYHWpeoXy0U56Fd4ujHzv3zd64FZsOu02MfaCYQ-IdMA&oe=69955485",
          "https://scontent.fhan14-3.fna.fbcdn.net/v/t39.30808-6/539525018_2057798944971076_3528129770734802286_n.jpg?stp=cp6_dst-jpg_tt6&_nc_cat=103&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeGdblq3ys_-MmRqXe3sWKhIp4cPQfYW9BGnhw9B9hb0EYE1eR26BsfTig_cPFeZr5BRpydt6OV9ub-MAkYDsqJr&_nc_ohc=IfC5dxNGQkgQ7kNvwFj9gDl&_nc_oc=AdlR34lWBAZ1QXiudyYFiDYMZ6dW7CJtYgUI1LKUCeSrdmDEs7e9EtWj7ZwufngST5rkY5RwUrCZY6xrq-lEH86j&_nc_zt=23&_nc_ht=scontent.fhan14-3.fna&_nc_gid=oMw1Cq25fGvotKee3779Ug&oh=00_Afvn55-Yeb_LdVk74L3qLLU3DBloTaSnpvHab8sd62FaJQ&oe=69953914",
          "https://scontent.fhan14-5.fna.fbcdn.net/v/t39.30808-6/525898636_2037936906957280_5649238475024882972_n.jpg?stp=cp6_dst-jpg_tt6&_nc_cat=104&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeFZPx8uq4B30qD283GPwMjZ1pDyalVZA7rWkPJqVVkDutnGZSOaIbEpyUH0GGdLGtmPH6Wc2jGl1pjxrP3pIG8l&_nc_ohc=kVafvQOxD3MQ7kNvwEhudPZ&_nc_oc=AdlzmcZvulDVaVFWnyIdp6lrhcQOEVmUcIiUb0rlUQmrldg4d-EcqQSNl5GzCEP5MxVFBgGsDxkhuN_pNIQtYPuE&_nc_zt=23&_nc_ht=scontent.fhan14-5.fna&_nc_gid=mar6u6UP_qu8oGw3LpDbNA&oh=00_Afsy9oWchaio4H7inbDKa_i-KXJ6BjnYgbnKNOQY8awO1g&oe=699557CF",
          "https://scontent.fhan14-5.fna.fbcdn.net/v/t39.30808-6/526585500_2037936866957284_7810454947812048809_n.jpg?_nc_cat=104&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeH54NUM1wkrWhp8kW5WpORhr9UsI2KuKBWv1SwjYq4oFVzIe5O-QknBVlUmnW68r-f2UrwiW2WFG3vsftFEFlc5&_nc_ohc=5BtTf-RoOvUQ7kNvwH8eHUv&_nc_oc=AdlDRqaPrTEx8QZmgJwrvp1-1nOyROp4sxbP0UKnC8XTrwTdNN1ZkHS-EXqdPesfu57353id3CyA0973IxfVtkG2&_nc_zt=23&_nc_ht=scontent.fhan14-5.fna&_nc_gid=0d-F-kixfCgaUrNzo53rvg&oh=00_AfuK9Fi6_J0bi9ADRvyU6-pf6Ym_kM7FMMwJ81BSnscs2g&oe=69955151",
          "https://scontent.fhan14-3.fna.fbcdn.net/v/t39.30808-6/486828022_1941401239944181_7035835113644488089_n.jpg?_nc_cat=110&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeHlpOdnvO_6ypmgZi6FQ7eE991Lmlheq7X33UuaWF6rtS2f5bncP4cOU2KSYFHuR5IDAsMV8ORWBhKp56VquRs3&_nc_ohc=Np2A642lhTcQ7kNvwGkw3AU&_nc_oc=Adlae2fMZp2gi0T9-AzLHWgEayXZ0MS2ARl4FaKnhZLx4Hq-59vp-p8NSdGTxtVTrKXeq1D1qa8j10oKLwzIqrzG&_nc_zt=23&_nc_ht=scontent.fhan14-3.fna&_nc_gid=6adu8iDBhxvseANULXk4fA&oh=00_Aft1h8tEbRQCKkvSGcN3YJ3lohb4fBgpksYAhfzcllfVLw&oe=699550B7",
          "https://scontent.fhan14-1.fna.fbcdn.net/v/t39.30808-6/487481796_1940581300026175_618409989433259878_n.jpg?stp=cp6_dst-jpg_tt6&_nc_cat=101&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeH9LNNzhq9VsS0Av6UMAfrSozWT7j5lls2jNZPuPmWWzXGaezwPMBzBJzfUBF4ghGsbZ7fQgFOY6vRL0nK-LE2i&_nc_ohc=hjYMI_Hm7LcQ7kNvwGzoqim&_nc_oc=Adn3Iz_4QZ6pZ-evv3svoz9i9OnvbCz_FsH2kd05ky0Al2Fp_PYbMRUEBG2QYfrcKQLOYhYxQEhv0r_mXeSpsQ1i&_nc_zt=23&_nc_ht=scontent.fhan14-1.fna&_nc_gid=Op5bl4tw6oYYIx3ywk8TGw&oh=00_AfvP-YEx0QnmGxalkSaH5AQ2eMF4zfBWTy06dDg94LaN5w&oe=69954276",
          "https://scontent.fhan14-5.fna.fbcdn.net/v/t39.30808-6/487482788_1940407880043517_7758789578040405082_n.jpg?_nc_cat=104&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeEQAbpdogfAvMFvloPUcRheABrQmLzW42EAGtCYvNbjYTZMqBLBYfpVCTebojQSxB76JHfzFXbsiJNZ2TW8R1V1&_nc_ohc=q0RSHMkTM5UQ7kNvwFEyVED&_nc_oc=AdnYvVLPm0GrHZC8FILC0EFJCU5R2TMQ2RULHt6diIZeIWzc832YRXsdN-1CjqdikeeOsUy2Hyjj0homCXU8Yiwm&_nc_zt=23&_nc_ht=scontent.fhan14-5.fna&_nc_gid=keXZfQ3SJz7XLSJLCo_L1Q&oh=00_AfvS2pEQB9wctXFtFiVI05a3OxGZ_B_09saAiU5wIIhrgQ&oe=69953C7E",
          "https://scontent.fhan14-3.fna.fbcdn.net/v/t39.30808-6/486238914_1936076173810021_2128134687267130525_n.jpg?_nc_cat=111&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeF0lX3ZRn29peI6HdIZm3Yf0O1KDlwghNbQ7UoOXCCE1jyccn54Taf5DpbSBxrfjqiq1lxBt35DrJgnDlcDyqda&_nc_ohc=47NehvKkZ0oQ7kNvwEHmUr9&_nc_oc=AdnVR3Cq-VMlSyU1XFMEPuawzIFn-TSY3WpmFXv4VH4zBlgGRVf5DzpP0kMj86jWnPVOMazY4or4Dh0vh3u1Hxm3&_nc_zt=23&_nc_ht=scontent.fhan14-3.fna&_nc_gid=JDgdSmPWk5QBhbVu2GezNw&oh=00_AfsUtkUtv3B1z3JHtAKO4Dt0G6-DOF3ZC-yUBUlSYjA_Fg&oe=6995467C",
          "https://scontent.fhan14-5.fna.fbcdn.net/v/t39.30808-6/485705841_1932758477475124_8766041973712118288_n.jpg?_nc_cat=109&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeFFplqOG-5NGsQTK2C6djuW3xadreS2-gLfFp2t5Lb6AoeVvqXo3ctta-CznoRvMTVallrfQGZS40FGzro7RvEE&_nc_ohc=jIL-xIv6LJYQ7kNvwFyKkky&_nc_oc=AdmyCpeN7QKhpaMC1O42SroChS9Q_RPAK7lmTuzzXh_Jdr6vx7UQAWshv3NDbQmOTT2qDnUvFzv45EJ_xAMdUli5&_nc_zt=23&_nc_ht=scontent.fhan14-5.fna&_nc_gid=n6gpcj27_zCKTTP0TQ1z0g&oh=00_AfvH918ngnLka1JzqPKWAj6Rf2Mv50y2wnxDoy-5ekLkiQ&oe=69954218",
          "https://scontent.fhan14-5.fna.fbcdn.net/v/t39.30808-6/484435728_1930324654385173_5234987349626683827_n.jpg?_nc_cat=109&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeEEr-VaStI2CzmlwxVu4eL2FuaFtd2JQsgW5oW13YlCyHVlGP7EG5sZ5r5alzImMqMNCdPdCv6JVN3ZKWzOuBsk&_nc_ohc=04lblG8Td5UQ7kNvwFQQXeI&_nc_oc=AdlR3-caDaOjOHHfe0ALE063x66hvkP6b7rALdeKLCv9hIaW9xNIh0GMuw7p6KvtDe6_1V4Po54YjPPnevD7C0F9&_nc_zt=23&_nc_ht=scontent.fhan14-5.fna&_nc_gid=7iSZdbrin9yWkrkPTai4yA&oh=00_AfvjV0Rsre4UYO_KENNVzKAVDfWOG-qDBB_ec8I74mi9Cw&oe=69953533",
          "https://scontent.fhan14-3.fna.fbcdn.net/v/t39.30808-6/482222717_1926366544780984_3333304143761198356_n.jpg?_nc_cat=111&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeFl20uj_sP2wxzv89gsFDatsJi6bdysY2ewmLpt3KxjZ2l6EDBolYAkQOb60aT8l5vp719kUlHk8BkJEsTAnL32&_nc_ohc=iEzm7IMaDnwQ7kNvwHxt0v4&_nc_oc=AdkpVtXMbLRMgu_fCtD2AOuhGG6wp0_H3hiic3HGzm5Jt7khkNauT0vqrtAsW-fKZFP83hM-qzlStP3SffZ9AVUE&_nc_zt=23&_nc_ht=scontent.fhan14-3.fna&_nc_gid=Gzd8HYSUNYx5x9SMLCp0gQ&oh=00_Afu9cKXVVaani-iBQ-3afpOiJYH5kDSA0yx_YpvoNnqHDw&oe=699522BA",
          "https://scontent.fhan14-2.fna.fbcdn.net/v/t39.30808-6/482223978_1926360864781552_3583681330997653302_n.jpg?_nc_cat=108&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeHU1_zWrVCjJLBZ9MEb_iLjzHfiTX31ZJLMd-JNffVkksUs33rpCoNYWruM7S_glMXC5dlipCh4yndkX7gN78PP&_nc_ohc=Qc2rHIyxbWcQ7kNvwFuHbPg&_nc_oc=Adl66t6pc1r_0mMHHZO4S9FkuXb5sT43B3v4jaMkcTjxubZddzzS56lecR2unDqWuGDmlH4IjHVGKryjZx8aFquJ&_nc_zt=23&_nc_ht=scontent.fhan14-2.fna&_nc_gid=qiN_wP47T4QuRKcfRcxqXQ&oh=00_Afvmu90KqVAkC58e7p2cw1rLhPOL-5hCt1_MLCzYoOZEiA&oe=69955031"
        ];
        
        // Tr·∫£ v·ªÅ danh s√°ch ƒë·ªÉ c√°c h√†m sau x·ª≠ l√Ω
        return urls;
      }

      let IMAGES = [],
        nextIdx = 0,
        remaining = 0;

      const occupied = [];
      const GAP_PAD = 20;
      const KEEP_OUT_PAD = 160;

      function rectInflate(rc, p) {
        return {
          left: rc.left - p,
          top: rc.top - p,
          right: rc.right + p,
          bottom: rc.bottom + p,
        };
      }
      function ptInRect(pt, rc) {
        return (
          pt.x > rc.left && pt.x < rc.right && pt.y > rc.top && pt.y < rc.bottom
        );
      }
      function keepoutRects() {
        const gift = document.getElementById("gift").getBoundingClientRect();
        const hint = document.querySelector(".hint").getBoundingClientRect();
        const notice = document
          .getElementById("notice")
          .getBoundingClientRect();
        const giftKO = rectInflate(gift, KEEP_OUT_PAD);
        const hintKO = rectInflate(hint, 40);
        const noticeKO = rectInflate(notice, 20);
        return [giftKO, hintKO, noticeKO];
      }
      function inAnyKeepout(p, rects) {
        return rects.some((rc) => ptInRect(p, rc));
      }

      function imageSize() {
        const isMobile = innerWidth < 600;
        const W = isMobile
          ? Math.min(110, innerWidth * 0.3)
          : Math.min(180, innerWidth * 0.18);
        const H = Math.round(W * 1.2); // ƒê·ªÉ ·∫£nh d·ªçc (Portrait) th∆∞·ªùng ƒë·∫πp h∆°n tr√™n ƒëi·ªán tho·∫°i
        return { W, H };
      }

      function updateRemain() {
        const el = document.getElementById("remainTxt");
        const teasers = [
          "T√¨nh y√™u v·∫´n c√≤n ti·∫øp di·ªÖn...",
          "M·ªü ti·∫øp ƒë·ªÉ th·∫•y ƒëi·ªÅu ng·ªçt ng√†o ‚ú®",
          "M·ªói t·∫•m h√¨nh l√† m·ªôt k·ª∑ ni·ªám...",
          "V·∫´n c√≤n b·∫•t ng·ªù ph√≠a sau ƒë√≥!",
          "Ch·∫°m ƒë·ªÉ nh·∫≠n th√™m y√™u th∆∞∆°ng üíñ",
          "Nh·ªØng kho·∫£nh kh·∫Øc ƒë·∫πp v·∫´n ƒëang ch·ªù...",
          "M·ªü th√™m ƒë·ªÉ th·∫•y tr√°i tim rung ƒë·ªông!",
          "T√¨nh y√™u kh√¥ng bao gi·ªù d·ª´ng l·∫°i...",
          "H√£y ƒë·ªÉ t√¨nh y√™u lan t·ªèa th√™m n·ªØa!",
          "M·ªói b·ª©c ·∫£nh l√† m·ªôt n·ª• c∆∞·ªùi...",
        ];
        el.textContent = teasers[(Math.random() * teasers.length) | 0];
      }

      function rectsOverlap(a, b, pad) {
        const ax1 = a.x - a.w / 2 - pad,
          ay1 = a.y - a.h / 2 - pad,
          ax2 = a.x + a.w / 2 + pad,
          ay2 = a.y + a.h / 2 + pad;
        const bx1 = b.x - b.w / 2 - pad,
          by1 = b.y - b.h / 2 - pad,
          bx2 = b.x + b.w / 2 + pad,
          by2 = b.y + b.h / 2 + pad;
        return !(ax2 < bx1 || bx2 < ax1 || ay2 < by1 || by2 < ay1);
      }
      function isFreeSpot(pt, w, h) {
        for (const o of occupied) {
          if (
            rectsOverlap(
              { x: pt.x, y: pt.y, w, h },
              { x: o.x, y: o.y, w: o.w, h: o.h },
              GAP_PAD,
            )
          )
            return false;
        }
        return true;
      }

      function pickTarget(from) {
        const { W, H } = imageSize();
        const pad = 20;

        // 1. X√°c ƒë·ªãnh v√πng gi·ªõi h·∫°n an to√†n tr√™n to√†n m√†n h√¨nh
        const xmin = W / 2 + pad;
        const xmax = innerWidth - W / 2 - pad;
        const ymin = H / 2 + pad;
        const ymax = innerHeight - H / 2 - pad;

        // 2. L·∫•y v·ªã tr√≠ h·ªôp qu√† ƒë·ªÉ t·∫°o "v√πng c·∫•m"
        const giftRect = document
          .getElementById("gift")
          .getBoundingClientRect();
        const safeMargin = 30; // Kho·∫£ng c√°ch t·ªëi thi·ªÉu ƒë·ªÉ kh√¥ng ch·∫°m h·ªôp qu√†

        const forbidden = {
          left: giftRect.left - W / 2 - safeMargin,
          right: giftRect.right + W / 2 + safeMargin,
          top: giftRect.top - H / 2 - safeMargin,
          bottom: giftRect.bottom + H / 2 + safeMargin,
        };

        const triesMax = 400;

        // 3. V√≤ng l·∫∑p t√¨m v·ªã tr√≠: ∆Øu ti√™n t√¨m ch·ªó tr·ªëng ho√†n to√†n
        for (let t = 0; t < triesMax; t++) {
          let tx = Math.random() * (xmax - xmin) + xmin;
          let ty = Math.random() * (ymax - ymin) + ymin;

          // Ki·ªÉm tra n·∫øu ƒë√® v√†o h·ªôp qu√† th√¨ b·ªè qua, t√¨m ƒëi·ªÉm kh√°c
          if (
            tx > forbidden.left &&
            tx < forbidden.right &&
            ty > forbidden.top &&
            ty < forbidden.bottom
          )
            continue;

          const pt = { x: tx, y: ty };
          // N·∫øu t√¨m th·∫•y ch·ªó kh√¥ng ƒë√® l√™n ·∫£nh kh√°c, tr·∫£ v·ªÅ ngay
          if (isFreeSpot(pt, W, H)) {
            return pt;
          }
        }

        // 4. M·ª§C D·ª∞ PH√íNG: N·∫øu m√†n h√¨nh ƒë√£ qu√° ch·∫≠t (sau 400 l·∫ßn th·ª≠ kh√¥ng th·∫•y ch·ªó tr·ªëng)
        // V·∫´n b·∫Øn ra m·ªôt v·ªã tr√≠ NG·∫™U NHI√äN tr√™n m√†n h√¨nh, ch·ªâ c·∫ßn tr√°nh h·ªôp qu√†
        for (let t = 0; t < 100; t++) {
          let tx = Math.random() * (xmax - xmin) + xmin;
          let ty = Math.random() * (ymax - ymin) + ymin;

          if (
            !(
              tx > forbidden.left &&
              tx < forbidden.right &&
              ty > forbidden.top &&
              ty < forbidden.bottom
            )
          ) {
            return { x: tx, y: ty };
          }
        }

        // 5. Tr∆∞·ªùng h·ª£p hy h·ªØu cu·ªëi c√πng: Tr·∫£ v·ªÅ m·ªôt g√≥c ng·∫´u nhi√™n
        return {
          x: Math.random() > 0.5 ? xmin : xmax,
          y: Math.random() > 0.5 ? ymin : ymax,
        };
      }

      function releaseOnePhoto(fromX, fromY) {
        if (remaining <= 0) return false;
        const src = IMAGES[nextIdx++];
        remaining--;
        updateRemain();
        const { W, H } = imageSize();
        const t = pickTarget({ x: fromX, y: fromY });

        occupied.push({ x: t.x, y: t.y, w: W, h: H });

        const img = document.createElement("img");
        img.src = src;
        img.className = "fly";
        img.style.cssText = `
      width: ${W}px; height: ${H}px; left: ${fromX}px; top: ${fromY}px;
      z-index: ${800 + occupied.length}; border: 4px solid white; border-radius: 8px;
      position: fixed; object-fit: cover; box-shadow: 0 10px 20px rgba(0,0,0,0.4);
      transform: translate(-50%,-50%) scale(0);
  `;
        document.body.appendChild(img);

        const randomRotation = Math.random() * 30 - 15; // Xoay t·ª± nhi√™n t·ª´ -15 ƒë·∫øn 15 ƒë·ªô

        img.animate(
          [
            {
              left: fromX + "px",
              top: fromY + "px",
              transform: "translate(-50%,-50%) scale(0.1) rotate(0deg)",
              opacity: 0,
            },
            {
              left: t.x + "px",
              top: t.y + "px",
              transform: `translate(-50%,-50%) scale(1) rotate(${randomRotation}deg)`,
              opacity: 1,
            },
          ],
          {
            duration: 1200, // TƒÉng th·ªùi gian bay l√™n 1.2s ƒë·ªÉ th·∫•y ·∫£nh lan t·ªèa ƒë·ªÅu ra c√°c g√≥c
            easing: "cubic-bezier(0.16, 1, 0.3, 1)", // Hi·ªáu ·ª©ng bay ch·∫≠m d·∫ßn c·ª±c m∆∞·ª£t
            fill: "forwards",
          },
        );

        return true;
      }

      addEventListener("resize", () => {
        const { W, H } = imageSize(),
          pad = 16,
          xmin = W / 2 + pad,
          ymin = H / 2 + pad,
          xmax = innerWidth - W / 2 - pad,
          ymax = innerHeight - H / 2 - pad,
          krs = keepoutRects();
        const imgs = [...document.querySelectorAll("img.fly")];
        imgs.forEach((el, i) => {
          let x = parseFloat(el.style.left),
            y = parseFloat(el.style.top);
          x = Math.max(xmin, Math.min(xmax, x));
          y = Math.max(ymin, Math.min(ymax, y));
          if (inAnyKeepout({ x, y }, krs))
            y = Math.min(y, krs[0].top - (H / 2 + 8));
          // t√°ch n·∫øu ch·∫°m l√°ng gi·ªÅng
          for (let j = 0; j < i; j++) {
            const o = occupied[j],
              me = { x, y, w: W, h: H };
            if (rectsOverlap(me, o, GAP_PAD)) {
              y = o.y + (o.h / 2 + H / 2 + GAP_PAD + 2);
              y = Math.min(y, ymax);
            }
          }
          el.style.left = x + "px";
          el.style.top = y + "px";
          occupied[i] = { x, y, w: W, h: H };
        });
      });

      function lettersSequenceAboveGift() {
        const wrap = document.getElementById("hbdWrap");
        wrap.innerHTML = "";
        const gift = document.getElementById("gift");
        const r = gift.getBoundingClientRect();

        // ƒê·∫©y wrap l√™n cao h∆°n ƒë·ªÉ ch·ª©a ƒë∆∞·ª£c 3 d√≤ng ch·ªØ
        const topOfLid = r.top - 40;
        const cx = r.left + r.width / 2;

        wrap.style.top = topOfLid + "px";
        wrap.style.left = cx + "px";
        wrap.style.opacity = 1;
        wrap.style.textAlign = "center";

        // Danh s√°ch c√°c t·ª´ (M·ªói t·ª´ n·∫±m tr√™n m·ªôt d√≤ng ri√™ng)
        const words = ["Happy", "Valentine", "Day!"];
        let globalIndex = 0;

        words.forEach((word) => {
          const wordRow = document.createElement("div");
          wordRow.style.display = "block";
          wordRow.style.whiteSpace = "nowrap";

          // S·ª≠ d·ª•ng Array.from ƒë·ªÉ t√°ch k√Ω t·ª± ti·∫øng Vi·ªát c√≥ d·∫•u ch√≠nh x√°c
          Array.from(word).forEach((ch) => {
            const s = document.createElement("span");
            s.className = "hbd-letter";
            s.textContent = ch;

            wordRow.appendChild(s);

            // Hi·ªáu ·ª©ng hi·ªán ra l·∫ßn l∆∞·ª£t
            s.style.animation = `letterPop .55s cubic-bezier(.2,.9,.2,1) ${globalIndex * 0.08}s both`;
            globalIndex++;
          });
          wrap.appendChild(wordRow);
        });

        const total = (letters.length - 1) * 0.08 + 0.55;

        setTimeout(() => {
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              const pts = letters.map((el) => {
                const rr = el.getBoundingClientRect();
                return {
                  x: (rr.left + rr.right) / 2,
                  y: (rr.top + rr.bottom) / 2,
                };
              });
              fireworks(pts, 900);
              wrap.animate([{ opacity: 1 }, { opacity: 0 }], {
                duration: 700,
                delay: 400,
                fill: "forwards",
              });
              setTimeout(() => {
                wrap.innerHTML = "";
              }, 1200);
            });
          });
        }, total * 1000);
      }

      function drawHeart(ctx, x, y, size, color) {
        ctx.save();
        ctx.beginPath();
        ctx.translate(x, y);
        ctx.fillStyle = color;
        // Ph∆∞∆°ng tr√¨nh to√°n h·ªçc t·∫°o h√¨nh tr√°i tim
        for (let i = 0; i <= Math.PI * 2; i += 0.1) {
          const dx = size * 16 * Math.pow(Math.sin(i), 3);
          const dy =
            -size *
            (13 * Math.cos(i) -
              5 * Math.cos(2 * i) -
              2 * Math.cos(3 * i) -
              Math.cos(4 * i));
          if (i === 0) ctx.moveTo(dx, dy);
          else ctx.lineTo(dx, dy);
        }
        ctx.fill();
        ctx.restore();
      }

      function fireworks(points, duration = 600) {
        const c = document.getElementById("fireworks"),
          ctx = c.getContext("2d");
        const dpr = Math.min(devicePixelRatio || 1, 2);
        c.width = innerWidth * dpr;
        c.height = innerHeight * dpr;
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);
        const cols = ["#ff4d6d", "#ff758f", "#ff8fa3", "#ffb3c1", "#c9184a"];
        const parts = [];
        points.forEach((p) => {
          for (let i = 0; i < 40; i++) {
            const a = Math.random() * Math.PI * 2,
              s = 2 + Math.random() * 4;
            parts.push({
              x: p.x,
              y: p.y,
              vx: Math.cos(a) * s,
              vy: Math.sin(a) * s,
              life: 0,
              col: cols[i % cols.length],
              sz: 0.1 + Math.random() * 0.2,
            });
          }
        });
        const t0 = performance.now();
        (function tick(t) {
          ctx.clearRect(0, 0, innerWidth, innerHeight);
          parts.forEach((pt) => {
            pt.life += 1;
            pt.x += pt.vx;
            pt.y += pt.vy;
            pt.vy += 0.05;
            ctx.globalAlpha = Math.max(0, 1 - pt.life / 60);
            ctx.fillStyle = pt.col;
            drawHeart(ctx, pt.x, pt.y, pt.sz, pt.col);
          });
          ctx.globalAlpha = 1;
          if (t - t0 < duration) requestAnimationFrame(tick);
          else ctx.clearRect(0, 0, innerWidth, innerHeight);
        })(t0);
      }

      function openBurstFx(origin, mini = false) {
        const ring = document.createElement("div");
        ring.className = "ring";
        ring.style.left = origin.x + "px";
        ring.style.top = origin.y + "px";
        document.body.appendChild(ring);
        setTimeout(() => ring.remove(), 1200);
        const left = document.createElement("div"),
          right = document.createElement("div");
        left.className = "banner";
        right.className = "banner";
        const len = mini ? 260 : Math.min(380, innerWidth * 0.32);
        const r = document.getElementById("gift").getBoundingClientRect();
        const h = r.top + 26;
        Object.assign(left.style, {
          left: origin.x + "px",
          top: h + "px",
          width: "0px",
          transform: "scaleX(0.001)",
        });
        Object.assign(right.style, {
          left: origin.x + "px",
          top: h + 14 + "px",
          width: "0px",
          transformOrigin: "right center",
          transform: "scaleX(0.001)",
        });
        document.body.append(left, right);
        left.animate(
          [
            { transform: "scaleX(0.001)" },
            { transform: `scaleX(${len / 10})` },
          ],
          {
            duration: mini ? 720 : 900,
            easing: "cubic-bezier(.2,.9,.2,1)",
            fill: "forwards",
          },
        );
        right.animate(
          [
            { transform: "scaleX(0.001)" },
            { transform: `scaleX(${len / 10})` },
          ],
          {
            duration: mini ? 720 : 900,
            easing: "cubic-bezier(.2,.9,.2,1)",
            fill: "forwards",
            delay: 70,
          },
        );
        setTimeout(
          () => {
            left.remove();
            right.remove();
          },
          mini ? 900 : 1100,
        );
        const pieces = mini ? 16 : 26;
        for (let i = 0; i < pieces; i++) {
          const p = document.createElement("div");
          p.className = "ribbon-piece";
          p.style.left = origin.x + "px";
          p.style.top = origin.y + "px";
          document.body.appendChild(p);
          const ang = Math.random() * Math.PI * 2,
            spd = (mini ? 170 : 210) + Math.random() * 190,
            dx = Math.cos(ang) * spd,
            dy = Math.sin(ang) * spd * 0.85,
            rot = (Math.random() * 360) | 0;
          p.animate(
            [
              { transform: `translate(0,0) rotate(${rot}deg)`, opacity: 1 },
              {
                transform: `translate(${dx}px,${dy}px) rotate(${rot + 360}deg)`,
                opacity: 0,
              },
            ],
            {
              duration: (mini ? 850 : 1000) + Math.random() * 300,
              easing: "cubic-bezier(.2,.8,.25,1)",
              fill: "forwards",
            },
          );
          setTimeout(() => p.remove(), 1400);
        }
      }

      let finaleDone = false,
        emptyStreak = 0,
        emptyReset = null;
      let heatLevel = 0;
      function updatePreflash() {
        const pf = document.getElementById("preflash");
        pf.style.opacity = String(Math.min(1, 0.13 * heatLevel));
        const gift = document.getElementById("gift");
        gift.animate(
          [
            { transform: "translateY(0)" },
            { transform: `translateY(-${Math.min(6, heatLevel)}px)` },
            { transform: "translateY(0)" },
          ],
          { duration: 260, easing: "ease-in-out" },
        );
      }
      function encourage() {
        const msgs = [
          "Y√™u l√† ph·∫£i click! üöÄ",
          "G·∫ßn ƒë·∫øn l√∫c b√πng n·ªï r·ªìi ‚ú®",
          "Tr√°i tim ƒëang ƒë·∫≠p nhanh h∆°n...",
          "S·∫Øp th·∫•y ƒëi·ªÅu ƒë·∫∑c bi·ªát nh·∫•t r·ªìi!",
        ];
        const i = Math.min(emptyStreak, msgs.length - 1);
        document.getElementById("remainTxt").textContent = msgs[i];
      }
      function explodeGift() {
        if (finaleDone) return;
        finaleDone = true;
        const gift = document.getElementById("gift");
        const r = gift.getBoundingClientRect();
        const cx = r.left + r.width / 2,
          cy = r.top + r.height / 2;
        const flash = document.createElement("div");
        flash.className = "flash";
        document.body.appendChild(flash);
        flash.style.animation = "flashAnim 780ms ease-out forwards";
        setTimeout(() => flash.remove(), 820);
        const shock = document.createElement("div");
        shock.className = "shock";
        document.body.appendChild(shock);
        setTimeout(() => shock.remove(), 1600);
        for (let i = 0; i < 30; i++) {
          const f = document.createElement("div");
          f.innerHTML = "‚ù§Ô∏è";
          f.style.position = "fixed";
          f.style.fontSize = 15 + Math.random() * 20 + "px";
          f.style.left = cx + "px";
          f.style.top = cy + "px";
          f.style.zIndex = "3980";
          f.style.pointerEvents = "none";
          document.body.appendChild(f);

          const ang = Math.random() * Math.PI * 2,
            dist = 150 + Math.random() * 300;
          const dx = Math.cos(ang) * dist,
            dy = Math.sin(ang) * dist;

          f.animate(
            [
              {
                transform: "translate(-50%,-50%) scale(0) rotate(0deg)",
                opacity: 1,
              },
              {
                transform: `translate(${dx}px,${dy}px) scale(1.5) rotate(${360 + Math.random() * 360}deg)`,
                opacity: 0,
              },
            ],
            {
              duration: 1500 + Math.random() * 500,
              easing: "cubic-bezier(.2,.9,.2,1)",
              fill: "forwards",
            },
          );

          setTimeout(() => f.remove(), 2000);
        }
        gift.style.transition = "opacity .25s ease, transform .25s ease";
        gift.style.opacity = "0";
        gift.style.transform = "scale(.92) translateY(8px)";
        setTimeout(() => (gift.style.display = "none"), 300);
        setTimeout(showLetter, 1000);
      }
      function showLetter() {
        const overlay = document.getElementById("letterOverlay");
        const card = document.getElementById("letter");
        overlay.style.display = "grid";
        card.animate(
          [
            { opacity: 0, transform: "translateY(20px) scale(.98)" },
            { opacity: 1, transform: "translateY(0) scale(1)" },
          ],
          {
            duration: 520,
            easing: "cubic-bezier(.2,.9,.2,1)",
            fill: "forwards",
          },
        );
        document.getElementById("closeLetter").onclick = () => {
          overlay.animate([{ opacity: 1 }, { opacity: 0 }], {
            duration: 320,
            fill: "forwards",
          });
          setTimeout(() => (overlay.style.display = "none"), 340);
        };
      }

      /* ===== Click flow ===== */
      const giftEl = document.getElementById("gift");
      let firstPlayed = false,
        cooling = false;
      function mouthXY() {
        const r = giftEl.getBoundingClientRect();
        return { x: r.left + r.width / 2, y: r.top + r.height * 0.56 };
      }
      giftEl.addEventListener(
        "touchstart",
        (e) => {
          e.preventDefault(); // NgƒÉn ch·∫∑n double tap zoom
          giftEl.click();
        },
        { passive: false },
      );
      giftEl.addEventListener("click", () => {
        if (!isMusicPlaying && !firstPlayed) {
          toggleMusic();
        }
        if (cooling || finaleDone) return;
        cooling = true;
        setTimeout(() => (cooling = false), 240);
        const pos = mouthXY();
        if (!firstPlayed) {
          firstPlayed = true;
          giftEl.classList.add("opened");
          openBurstFx(pos, false);
          runConfetti(pos, 70);
          lettersSequenceAboveGift();
          return;
        }
        if (remaining > 0) {
          openBurstFx(pos, true);
          releaseOnePhoto(pos.x, pos.y);
          emptyStreak = 0;
          clearTimeout(emptyReset);
          emptyReset = null;
          heatLevel = 0;
          updatePreflash();
          updateRemain();
        } else {
          heatLevel = Math.min(10, heatLevel + 0.8);
          updatePreflash();
          openBurstFx(pos, true);
          giftEl.querySelector(".lid").animate(
            [
              { transform: "rotateX(60deg) translateY(-10px)" },
              {
                transform: "rotateX(60deg) translateY(-10px) translateX(-6px)",
              },
              {
                transform: "rotateX(60deg) translateY(-10px) translateX(6px)",
              },
              { transform: "rotateX(60deg) translateY(-10px)" },
            ],
            { duration: 520, easing: "ease-in-out" },
          );
          emptyStreak++;
          encourage();
          if (emptyReset) clearTimeout(emptyReset);
          emptyReset = setTimeout(() => {
            emptyStreak = 0;
            heatLevel = 0;
            updatePreflash();
            updateRemain();
          }, 2000);
          if (emptyStreak >= 10) {
            explodeGift();
          }
        }
      });

      /* ===== Boot ===== */
      (async () => {
        IMAGES = await loadUserImages();
        nextIdx = 0;
        remaining = IMAGES.length;
        updateRemain();
      })();
    </script>
  </body>
</html>
