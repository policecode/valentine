<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üéÅ H·ªôp Qu√† Vui Nh·ªôn</title>
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{ --glow:#69e6ff; --brand:#2b7fff; }
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;overflow:hidden;color:#fff;font-family:"Plus Jakarta Sans",system-ui;background:#030617}
#space{position:fixed;inset:0;z-index:-3}

/* ===== Gift box ===== */
.stage{position:fixed;inset:0;display:grid;place-items:center;z-index:1100}
.gift{position:relative;width:280px;height:240px;cursor:pointer;transform-style:preserve-3d;perspective:1200px;filter:drop-shadow(0 14px 28px #0007);transition:transform .6s cubic-bezier(.2,.9,.2,1);z-index:1200}
.gift:hover{transform:translateY(-6px) rotateX(3deg) rotateY(-2deg)}
.box,.lid{position:absolute;left:50%;transform:translateX(-50%);width:100%}
.box{bottom:0;height:66%;border-radius:20px;background:linear-gradient(180deg,#ff2c2c,#d80f0f 65%,#a90b0b);box-shadow:inset 0 0 0 1px #8d0a0a,inset 0 -10px 30px #0006,0 12px 40px #0008}
.ribbon-v,.ribbon-h{position:absolute;background:linear-gradient(180deg,#ffffff,#e7e7e7)}
.ribbon-v{width:24px;left:calc(50% - 12px);top:0;height:100%;border-radius:10px}
.ribbon-h{height:20px;width:100%;top:44%;left:0}
.lid{top:0;height:30%;transform-origin:50% 100%;border-radius:20px 20px 12px 12px;background:linear-gradient(180deg,#ff3a3a,#d20d0d 70%,#a30a0a);box-shadow:inset 0 0 0 1px #7b0808,0 10px 20px #0009;transition:transform .9s cubic-bezier(.16,1,.3,1)}
.lid::after{content:"";position:absolute;left:6%;right:6%;bottom:-5px;height:8px;border-radius:0 0 10px 10px;background:linear-gradient(180deg,#b90b0b,#7a0707);box-shadow:0 5px 10px #0008}
.lid .ribbon-v{height:100%;border-radius:10px}
.bow{position:absolute;top:-2px;left:50%;transform:translateX(-50%);width:120px;height:56px}
.bow .loop{position:absolute;top:6px;width:56px;height:36px;border-radius:40px 40px 14px 14px;background:linear-gradient(180deg,color-mix(in oklab,var(--brand) 95%,#fff) 0%,#215df7 80%);box-shadow:0 6px 12px #0006,inset 0 -6px 10px #1849cf}
.bow .loop.left{left:0;transform:rotate(-10deg)} .bow .loop.right{right:0;transform:rotate(10deg)}
.bow .knot{position:absolute;left:50%;top:16px;transform:translateX(-50%);width:26px;height:26px;border-radius:50%;background:linear-gradient(180deg,#4ea2ff,#1e66ff);box-shadow:0 0 10px #4ea2ffaa,inset 0 -6px 10px #194ed0}


.glow{position:absolute;inset:0;border-radius:inherit;pointer-events:none;box-shadow:0 0 22px 4px var(--glow) inset,0 0 36px 14px var(--glow);opacity:0;transition:opacity .6s}
.preflash{position:absolute;inset:-6px;border-radius:22px;pointer-events:none;box-shadow:0 0 18px 8px rgba(255,255,255,.7) inset, 0 0 70px 26px rgba(255,255,255,.55);filter:blur(0.3px); opacity:0; transition:opacity .28s ease}
.opened .lid{transform:rotateX(60deg) translateY(-10px) scale(1.02)} .opened .glow{opacity:.8}
.spark{position:absolute;inset:-18%;pointer-events:none;opacity:0} .opened .spark{opacity:1}
.hint{position:absolute;top:100%;left:50%;transform:translate(-50%,18px);color:#a7b3c4;font-weight:600;animation:breathe 2.4s ease-in-out infinite;text-align:center;z-index:1250}
.hint small{display:block;opacity:.8}
@keyframes breathe{0%,100%{opacity:1;transform:translate(-50%,18px)}50%{opacity:.5;transform:translate(-50%,22px)}}


#hbdWrap{position:fixed;left:50%;transform:translateX(-50%);pointer-events:none;z-index:3000;opacity:0}
.hbd-letter{
  display:inline-block;font-family:"Great Vibes",cursive;font-weight:900;font-size:96px;line-height:1;
  background:linear-gradient(90deg,#ff9de1,#ffe46b,#9de2ff);-webkit-background-clip:text;background-clip:text;color:transparent;
  text-shadow:0 0 16px rgba(255,255,255,.35);filter:drop-shadow(0 6px 16px rgba(0,0,0,.35));
  transform:translateY(30px) scale(.7) rotate(-6deg);opacity:0;
}
@keyframes letterPop{0%{opacity:0;transform:translateY(30px) scale(.7) rotate(-6deg)}60%{opacity:1;transform:translateY(-6px) scale(1.05) rotate(2deg)}100%{opacity:1;transform:translateY(0) scale(1) rotate(0)}}
#fireworks{position:fixed;inset:0;z-index:950;pointer-events:none}


img.fly{position:absolute;object-fit:cover;border-radius:18px;opacity:0;transform:translate(-50%,-50%) scale(.25);
  box-shadow:0 10px 34px #000a;transition:opacity .8s ease,transform 1.6s cubic-bezier(.2,.8,.25,1);z-index:800;will-change:transform,opacity;pointer-events:none}
img.fly:hover{transform:translate(-50%,-50%) scale(1.03)}
@keyframes calmFloat{0%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-52%) scale(1.02)}100%{transform:translate(-50%,-50%) scale(1)}}
img.fly.calm{ animation:calmFloat 9s ease-in-out 2; }


.ribbon-piece{position:fixed;width:14px;height:6px;border-radius:3px;background:linear-gradient(90deg,#ff9de1,#ffd166);box-shadow:0 0 10px rgba(255,200,220,.7);z-index:960;pointer-events:none}
.banner{position:fixed;height:10px;background:linear-gradient(#fff,#eee);border-radius:6px;box-shadow:0 2px 10px #0006;z-index:960;pointer-events:none;transform-origin:left center;opacity:.95}
.ring{position:fixed;width:10px;height:10px;border:3px solid rgba(255,255,255,.7);border-radius:50%;z-index:940;pointer-events:none;opacity:.9;transform:translate(-50%,-50%) scale(.35);animation:ringPulse 1200ms ease-out forwards}
@keyframes ringPulse{to{transform:translate(-50%,-50%) scale(3.2);opacity:0}}

.notice{position:fixed;bottom:12px;right:14px;font-size:12px;color:#b9c4d1a8;user-select:none;z-index:1000}

.flash{position:fixed;inset:0;background:#fff;opacity:0;z-index:4000;pointer-events:none}
@keyframes flashAnim{0%{opacity:.0} 10%{opacity:.95} 100%{opacity:0}}
.shock{position:fixed;left:50%;top:50%;width:20px;height:20px;border:2px solid #fff;border-radius:50%;transform:translate(-50%,-50%) scale(1);opacity:.85;z-index:3999;pointer-events:none;animation:shock 1500ms ease-out forwards}
@keyframes shock{to{transform:translate(-50%,-50%) scale(50);opacity:0}}
.frag{position:fixed;width:16px;height:12px;border-radius:3px;z-index:3980;pointer-events:none;background:linear-gradient(180deg,#ff3a3a,#a30a0a);box-shadow:0 6px 16px #000a,inset 0 -4px 8px #7b0808}

#letterOverlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);z-index:4200}
.letter{width:min(720px,92vw);background:#fff;color:#222;border-radius:14px;box-shadow:0 24px 90px rgba(0,0,0,.45);overflow:hidden;transform:translateY(20px) scale(.98);opacity:0;font-family: ui-serif, Georgia, "Times New Roman", serif}
.letter-header{background:linear-gradient(90deg,#ff9de1,#ffd166,#9de2ff);height:10px}
.letter-body{padding:22px 20px 26px}
.letter-body h2{margin:6px 0 10px;font-family:"Great Vibes",cursive;font-size:48px;color:#c2185b}
.letter-body p{line-height:1.65;margin:10px 0}
.letter-close{display:inline-flex;align-items:center;gap:8px;margin-top:14px;border:0;background:#111;color:#fff;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
</style>
</head>
<body>
<canvas id="space"></canvas>

<div id="hbdWrap" aria-hidden="true"></div>
<canvas id="fireworks"></canvas>

<main class="stage">
  <div class="gift" id="gift" aria-label="M·ªü h·ªôp qu√†">
    <div class="lid">
      <div class="ribbon-v"></div>
      <div class="bow"><div class="loop left"></div><div class="loop right"></div><div class="knot"></div></div>
    </div>
    <div class="box">
      <div class="ribbon-v"></div><div class="ribbon-h"></div>
      <div class="glow"></div>
      <div class="preflash" id="preflash"></div>
    </div>
    <canvas class="spark" id="spark" width="600" height="600"></canvas>
    <div class="hint">
      üéÅ H√£y ·∫•n v√†o t√¥i<br>
      <small id="remainTxt">S·∫µn s√†ng cho ƒëi·ªÅu b·∫•t ng·ªù ‚ú®</small>
    </div>
  </div>
</main>

<!-- L√° th∆∞ -->
<div id="letterOverlay">
  <div class="letter" id="letter">
    <div class="letter-header"></div>
    <div class="letter-body" id="letterContent">
      <h2>G·ª≠i b·∫°n th√¢n m·∫øn üíå</h2>
      <p>Ch√∫c m·ª´ng sinh nh·∫≠t! Mong b·∫°n lu√¥n m·∫°nh kh·ªèe, vui v·∫ª, l√†m ƒëi·ªÅu m√¨nh y√™u v√† ƒë∆∞·ª£c y√™u nh·ªØng ƒëi·ªÅu m√¨nh l√†m.</p>
      <p>H√£y gi·ªØ n·ª• c∆∞·ªùi, sƒÉn "bug" th·∫≠t kh√©o, v√† nh·ªõ r·∫±ng quanh  b·∫°n lu√¥n c√≥ nh·ªØng ng∆∞·ªùi tr√¢n qu√Ω b·∫°n.</p>
      <button class="letter-close" id="closeLetter">ƒê√≥ng l√° th∆∞</button>
    </div>
  </div>
</div>

<div class="notice" id="notice"></div>

<script>

(function(){
  const canvas=document.getElementById('space'),ctx=canvas.getContext('2d');
  const dpr=Math.min(devicePixelRatio||1,2);
  function resize(){ canvas.width=innerWidth*dpr; canvas.height=innerHeight*dpr; ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr) }
  resize(); addEventListener('resize',resize,{passive:true});
  const TAU=Math.PI*2, W=()=>innerWidth, H=()=>innerHeight, rnd=(a,b)=>a+Math.random()*(b-a);

  const starLayers=[
    {count:Math.round(W()*H()/3600),size:[0.6,1.1],speed:0.018,tw:0.28,color:'#dfe8ff'},
    {count:Math.round(W()*H()/5200),size:[0.9,1.5],speed:0.04, tw:0.45,color:'#ffffff'},
    {count:Math.round(W()*H()/7800),size:[1.3,2.1],speed:0.07, tw:0.60,color:'#ffe3a6'}
  ].map(L=>({...L, arr:Array.from({length:L.count},()=>({x:Math.random()*W(),y:Math.random()*H(),r:rnd(L.size[0],L.size[1]),ph:Math.random()*TAU}))}));

  const nebulas = Array.from({length:4}, (_,i)=>({
    x:(i===0?W()*0.58:rnd(W()*0.10,W()*0.52)),
    y:(i===0?H()*0.40:rnd(H()*0.18,H()*0.82)),
    r:rnd(160,300),
    h:rnd(190,320),
    a:rnd(0.05,0.10)
  }));

  const star={x:()=>W()*0.18,y:()=>H()*0.55,R:70};
  const planets=[
    {a:110,b:82 ,r:8 ,h:38 ,sp:0.00045,phi:Math.random()*TAU, ring:false, moons:[]},
    {a:160,b:118,r:11,h:46 ,sp:0.00033,phi:Math.random()*TAU, ring:false, moons:[]},
    {a:215,b:160,r:12,h:210,sp:0.00028,phi:Math.random()*TAU, ring:false, moons:[{r:3,dist:24,spd:0.0015,phi:Math.random()*TAU}]},
    {a:280,b:205,r:10,h:12 ,sp:0.00023,phi:Math.random()*TAU, ring:false, moons:[{r:2,dist:18,spd:0.0022,phi:Math.random()*TAU}]},
    {a:380,b:275,r:20,h:34 ,sp:0.00016,phi:Math.random()*TAU, ring:false, moons:[{r:3,dist:32,spd:0.0017,phi:Math.random()*TAU}]},
    {a:470,b:340,r:16,h:46 ,sp:0.00013,phi:Math.random()*TAU, ring:true , moons:[]}
  ];

  let meteors=[]; function spawnMeteor(){ meteors.push({x:-60,y:rnd(0,H()*0.7),vx:rnd(6,10),vy:rnd(1.3,2.6),life:0,max:80}); setTimeout(spawnMeteor,rnd(2600,5600)) } setTimeout(spawnMeteor,1400);
  let comet=null; function spawnComet(){ const side=Math.random()<0.5?'L':'R',y=rnd(H()*0.18,H()*0.5); comet={x:side==='L'?-120:W()+120,y,vx:side==='L'?rnd(3.2,4.2):-rnd(3.2,4.2),vy:rnd(-0.35,0.15),trail:[]}; setTimeout(spawnComet,rnd(13000,22000)) } setTimeout(spawnComet,6500);

  const spiral = (function makeSpiral(){
    const TAU2=Math.PI*2, arms=4, ptsPerArm=900, spread=0.55, a0=14, b=0.22, scaleY=0.7;
    const sizeMul=1.25, rotBase=-0.18;
    const cx=()=>W()*0.78, cy=()=>H()*0.58;
    const stars=[];
    for(let k=0;k<arms;k++){
      const armOffset=(TAU2/arms)*k;
      for(let i=0;i<ptsPerArm;i++){
        const t = i/ptsPerArm * (Math.PI*3.6);
        const r = sizeMul * a0*Math.exp(b*t);
        const jx=(Math.random()-0.5)*spread*r*0.32;
        const jy=(Math.random()-0.5)*spread*r*0.32;
        const s = Math.random()<0.9 ? (0.7+Math.random()*0.9) : (1.6+Math.random()*0.8);
        const c = Math.random()<0.7 ? '#fff6c6' : (Math.random()<0.5 ? '#cfe3ff' : '#ffd9ff');
        stars.push({t:t+armOffset, r, jx, jy, s, c, ph:Math.random()*TAU2});
      }
    }
    const dust = Array.from({length:160}, ()=>({
      t:Math.random()*Math.PI*3.2,
      r:sizeMul*a0*Math.exp(b*Math.random()*Math.PI*3.2),
      size:10+Math.random()*14,
      alpha:0.05+Math.random()*0.07
    }));
    function draw(t){
      const ROT = rotBase + Math.sin(t*0.00006)*0.06;
      const C=Math.cos(ROT), S=Math.sin(ROT), x0=cx(), y0=cy();
      ctx.save(); ctx.globalCompositeOperation='lighter';
      const halo=ctx.createRadialGradient(x0,y0,60,x0,y0,300);
      halo.addColorStop(0,'rgba(255,240,255,.18)'); halo.addColorStop(0.6,'rgba(160,140,255,.08)'); halo.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=halo; ctx.beginPath(); ctx.arc(x0,y0,300,0,TAU2); ctx.fill();
      const core=ctx.createRadialGradient(x0,y0,0,x0,y0,100);
      core.addColorStop(0,'rgba(255,240,255,.32)'); core.addColorStop(1,'rgba(255,240,255,0)');
      ctx.fillStyle=core; ctx.beginPath(); ctx.arc(x0,y0,100,0,TAU2); ctx.fill();
      dust.forEach(d=>{
        const ang=d.t, rr=d.r;
        let x=rr*Math.cos(ang), y=rr*Math.sin(ang)*scaleY;
        const rx=C*x - S*y, ry=S*x + C*y;
        ctx.globalAlpha=d.alpha;
        const g=ctx.createRadialGradient(x0+rx,y0+ry,1,x0+rx,y0+ry,d.size);
        g.addColorStop(0,'rgba(210,190,255,1)'); g.addColorStop(1,'rgba(210,190,255,0)');
        ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x0+rx,y0+ry,d.size,0,TAU2); ctx.fill();
      });
      stars.forEach(s=>{
        const tw=0.5+0.5*Math.sin(t*0.001+s.ph);
        const ang=s.t + t*0.00005;
        let x=s.r*Math.cos(ang)+s.jx, y=(s.r*Math.sin(ang)+s.jy)*scaleY;
        const rx=C*x - S*y, ry=S*x + C*y;
        ctx.globalAlpha=tw*0.75; ctx.fillStyle=s.c;
        ctx.fillRect(x0+rx, y0+ry, s.s, s.s);
      });
      ctx.restore();
    }
    return {draw};
  })();

  function drawStars(t){
    starLayers.forEach((L,i)=>{
      L.arr.forEach(s=>{
        s.x+=L.speed; if(s.x>W()) s.x=0;
        const tw=0.45+0.55*Math.sin(t*0.001+s.ph+i);
        ctx.globalAlpha=.45+tw*L.tw;
        ctx.fillStyle=L.color;
        ctx.fillRect(s.x,s.y,s.r,s.r);
      });
    });
  }
  function drawNebulas(t){
    ctx.save(); ctx.globalCompositeOperation='lighter';
    nebulas.forEach(n=>{
      const r=n.r+10*Math.sin(t*0.0006);
      const g=ctx.createRadialGradient(n.x,n.y,r*.15,n.x,n.y,r);
      g.addColorStop(0,`hsla(${n.h},85%,60%,${n.a})`);
      g.addColorStop(.5,`hsla(${(n.h+60)%360},85%,52%,${n.a*.65})`);
      g.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(n.x,n.y,r,0,Math.PI*2); ctx.fill();
    }); ctx.restore();
  }
  function drawSun(t){
    const x=star.x(), y=star.y(), R=star.R;
    const g=ctx.createRadialGradient(x,y,R*.1,x,y,R*1.1);
    g.addColorStop(0,'#fff7d1'); g.addColorStop(.6,'#ffd36e'); g.addColorStop(1,'rgba(255,140,0,0)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,R,0,Math.PI*2); ctx.fill();
    ctx.save(); ctx.globalCompositeOperation='lighter'; ctx.strokeStyle='rgba(255,200,120,.30)'; ctx.lineWidth=2;
    for(let i=0;i<20;i++){ const a=i*(Math.PI*2/20)+Math.sin(t*0.0005+i)*.12; const r1=R*1.03, r2=R*1.55+Math.sin(t*0.002+i)*6;
      ctx.beginPath(); ctx.moveTo(x+Math.cos(a)*r1, y+Math.sin(a)*r1); ctx.lineTo(x+Math.cos(a)*r2, y+Math.sin(a)*r2); ctx.stroke(); }
    ctx.restore();
  }
  function drawPlanets(){
    const sx=star.x(), sy=star.y();
    ctx.save(); ctx.strokeStyle='rgba(255,255,255,.10)';
    planets.forEach(p=>{ ctx.beginPath(); ctx.ellipse(sx,sy,p.a,p.b,0,0,Math.PI*2); ctx.stroke(); }); ctx.restore();
    planets.forEach(p=>{
      p.phi+=p.sp; const px=sx+p.a*Math.cos(p.phi), py=sy+p.b*Math.sin(p.phi);
      const grd=ctx.createRadialGradient(px-p.r*.35,py-p.r*.35,p.r*.2,px,py,p.r);
      grd.addColorStop(0,`hsl(${p.h},80%,70%)`); grd.addColorStop(1,`hsl(${p.h},80%,35%)`);
      ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(px,py,p.r,0,Math.PI*2); ctx.fill();
      if(p.ring){ ctx.save(); ctx.translate(px,py); ctx.rotate(-.5); ctx.strokeStyle='rgba(255,255,255,.6)'; ctx.lineWidth=2.5; ctx.beginPath(); ctx.ellipse(0,0,p.r*1.8,p.r*.62,0,0,Math.PI*2); ctx.stroke(); ctx.restore(); }
      p.moons.forEach(m=>{ m.phi+=m.spd; const mx=px+Math.cos(m.phi)*m.dist, my=py+Math.sin(m.phi)*m.dist*.9; ctx.fillStyle='rgba(230,240,255,.95)'; ctx.beginPath(); ctx.arc(mx,my,m.r,0,Math.PI*2); ctx.fill(); });
    });
  }
  function drawMeteors(){
    ctx.save(); ctx.strokeStyle='#e6f7ff'; ctx.lineWidth=2; ctx.lineCap='round';
    meteors=meteors.filter(m=>{ m.x+=m.vx; m.y+=m.vy; m.life++; ctx.globalAlpha=Math.max(0,1-m.life/m.max);
      ctx.beginPath(); ctx.moveTo(m.x,m.y); ctx.lineTo(m.x-38,m.y-12); ctx.stroke();
      return m.x<W()+80 && m.life<m.max; });
    ctx.restore();
  }
  function drawComet(){
    if(!comet) return;
    comet.x+=comet.vx; comet.y+=comet.vy; comet.trail.push({x:comet.x,y:comet.y}); if(comet.trail.length>100) comet.trail.shift();
    ctx.save(); ctx.globalCompositeOperation='lighter';
    const g=ctx.createRadialGradient(comet.x,comet.y,1,comet.x,comet.y,18); g.addColorStop(0,'rgba(255,255,255,1)'); g.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(comet.x,comet.y,7,0,Math.PI*2); ctx.fill();
    for(let i=comet.trail.length-1;i>0;i--){ const p=comet.trail[i], a=i/comet.trail.length; ctx.globalAlpha=a*.45; ctx.beginPath(); ctx.arc(p.x,p.y,9*a,0,Math.PI*2); ctx.fillStyle='rgba(200,230,255,.5)'; ctx.fill(); }
    ctx.restore();
    if(comet.x<-140||comet.x>W()+140) comet=null;
  }
  function tick(t){
    ctx.clearRect(0,0,W(),H());
    drawNebulas(t); drawStars(t); spiral.draw(t); drawSun(t); drawPlanets(); drawMeteors(); drawComet();
    requestAnimationFrame(tick);
  }
  tick(0);
})();

/* ===== Confetti ===== */
function runConfetti(at, count=70){
  const colors=['#8a7bff','#22d3ee','#ffd166','#ff7d9b','#51ffcd'];
  for(let i=0;i<count;i++){
    const el=document.createElement('div'); el.style.cssText='position:fixed;width:8px;height:8px;border-radius:2px;opacity:.95;z-index:980;';
    el.style.background=colors[i%colors.length]; document.body.appendChild(el);
    const vx=(Math.random()-0.5)*12, vy=-Math.random()*14-6, rot=Math.random()*360; let t=0;
    (function step(){ t+=1; const x=at.x+vx*t, y=at.y+vy*t+0.35*t*t;
      el.style.transform=`translate(${x}px,${y}px) rotate(${rot+t*10}deg)`; el.style.opacity=String(1-t/110);
      if(t<110) requestAnimationFrame(step); else el.remove(); })();
  }
}

/* ===== N·∫°p ·∫£nh ===== */
async function loadUserImages(){
  try{ const r=await fetch('images/manifest.json',{cache:'no-store'}); if(r.ok){ const a=await r.json(); if(Array.isArray(a)&&a.length) return a.map(n=>'images/'+n) } }catch(_){}
  const exts=['jpg','jpeg','png','webp','gif'], urls=[]; const test=u=>new Promise(res=>{const im=new Image(); let d=false; const end=o=>{if(!d){d=true;res(o)}}; im.onload=()=>end(true); im.onerror=()=>end(false); setTimeout(()=>end(false),1200); im.src=u+'?v='+Math.random()});
  for(let i=1;i<=60;i++){ for(const e of exts){ const u=`images/${i}.${e}`; if(await test(u)){ urls.push(u); break; } } } return urls;
}


let IMAGES=[], nextIdx=0, remaining=0;

const occupied=[]; 
const GAP_PAD = 20;        
const KEEP_OUT_PAD=160;


function rectInflate(rc,p){ return {left:rc.left-p, top:rc.top-p, right:rc.right+p, bottom:rc.bottom+p}; }
function ptInRect(pt,rc){ return pt.x>rc.left && pt.x<rc.right && pt.y>rc.top && pt.y<rc.bottom; }
function keepoutRects(){
  const gift=document.getElementById('gift').getBoundingClientRect();
  const hint=document.querySelector('.hint').getBoundingClientRect();
  const notice=document.getElementById('notice').getBoundingClientRect();
  const giftKO = rectInflate(gift, KEEP_OUT_PAD);
  const hintKO = rectInflate(hint, 40);
  const noticeKO = rectInflate(notice, 20);
  return [giftKO, hintKO, noticeKO];
}
function inAnyKeepout(p, rects){ return rects.some(rc=>ptInRect(p,rc)); }


function imageSize(){
  const W=Math.max(130, Math.min(190, innerWidth*0.18)); // ‚Üì nh·ªè
  const H=Math.round(W*0.7);
  return {W,H};
}


function updateRemain(){
  const el=document.getElementById('remainTxt');
  const teasers=["C√≥ g√¨ ƒë√≥ n·ªØa ·ªü ƒë√¢y‚Ä¶","Ch·∫°m ti·∫øp ƒëi, bi·∫øt ƒë√¢u ‚ú®","H√¨nh nh∆∞ ch∆∞a h·∫øt ƒë√¢u‚Ä¶","ƒê·ª´ng d·ª´ng l·∫°i!","Ti·∫øp t·ª•c nh√©!","S·∫Øp c√≥ ƒëi·ªÅu hay ho‚Ä¶"];
  el.textContent = teasers[(Math.random()*teasers.length)|0];
}

function rectsOverlap(a,b,pad){
  const ax1=a.x - a.w/2 - pad, ay1=a.y - a.h/2 - pad, ax2=a.x + a.w/2 + pad, ay2=a.y + a.h/2 + pad;
  const bx1=b.x - b.w/2 - pad, by1=b.y - b.h/2 - pad, bx2=b.x + b.w/2 + pad, by2=b.y + b.h/2 + pad;
  return !(ax2 < bx1 || bx2 < ax1 || ay2 < by1 || by2 < ay1);
}
function isFreeSpot(pt,w,h){
  for(const o of occupied){ if(rectsOverlap({x:pt.x,y:pt.y,w,h},{x:o.x,y:o.y,w:o.w,h:o.h},GAP_PAD)) return false; }
  return true;
}

function pickTarget(from){
  const {W,H}=imageSize(), pad=16;
  const xmin=W/2+pad, ymin=H/2+pad, xmax=innerWidth-W/2-pad, ymax=innerHeight-H/2-pad;
  const triesMax=520, krs=keepoutRects();
  for(let t=0;t<triesMax;t++){
    const ang=Math.random()*Math.PI*2, rad=Math.min(innerWidth,innerHeight)*(.26+.46*Math.random());
    let tx=from.x+Math.cos(ang)*rad, ty=from.y-Math.sin(ang)*rad*0.85;
    tx=Math.max(xmin,Math.min(xmax,tx)); ty=Math.max(ymin,Math.min(ymax,ty));
    const pt={x:tx,y:ty};
    if(inAnyKeepout(pt,krs)) continue;
    if(isFreeSpot(pt,W,H)) return pt;
  }

  const corners=[{x:xmin,y:ymin},{x:xmax,y:ymin},{x:xmin,y:ymax},{x:xmax,y:ymax}]
    .filter(pt=>!inAnyKeepout(pt,krs) && isFreeSpot(pt,W,H));
  return corners[(Math.random()*corners.length)|0] || {x:xmax,y:ymin};
}

function releaseOnePhoto(fromX,fromY){
  if(remaining<=0) return false;
  const src=IMAGES[nextIdx++]; remaining--; updateRemain();
  const {W,H}=imageSize(); const t=pickTarget({x:fromX,y:fromY});
  occupied.push({x:t.x,y:t.y,w:W,h:H});
  const img=document.createElement('img'); img.src=src; img.className='fly';
  img.style.width=W+'px'; img.style.height=H+'px'; img.style.left=fromX+'px'; img.style.top=fromY+'px'; img.style.zIndex=800+occupied.length; document.body.appendChild(img);
  const mid={x:(fromX+t.x)/2+(Math.random()*110-55), y:(fromY+t.y)/2-100-Math.random()*40};
  img.style.opacity=1;
  const anim=img.animate(
    [
      {transform:'translate(-50%,-50%) scale(.25)',left:fromX+'px',top:fromY+'px',offset:0},
      {transform:'translate(-50%,-50%) scale(.94)',left:mid.x+'px',top:mid.y+'px',offset:.6},
      {transform:'translate(-50%,-50%) scale(1)',left:t.x+'px',top:t.y+'px',offset:1}
    ],
    {duration:1600,easing:'cubic-bezier(.2,.8,.25,1)',fill:'forwards'}
  );
  anim.finished.then(()=>img.classList.add('calm')).catch(()=>{});
  return true;
}

addEventListener('resize', ()=>{
  const {W,H}=imageSize(), pad=16, xmin=W/2+pad, ymin=H/2+pad, xmax=innerWidth-W/2-pad, ymax=innerHeight-H/2-pad, krs=keepoutRects();
  const imgs=[...document.querySelectorAll('img.fly')];
  imgs.forEach((el,i)=>{
    let x=parseFloat(el.style.left), y=parseFloat(el.style.top);
    x=Math.max(xmin,Math.min(xmax,x)); y=Math.max(ymin,Math.min(ymax,y));
    if(inAnyKeepout({x,y},krs)) y=Math.min(y, krs[0].top - (H/2+8));
    // t√°ch n·∫øu ch·∫°m l√°ng gi·ªÅng
    for(let j=0;j<i;j++){
      const o=occupied[j], me={x,y,w:W,h:H};
      if(rectsOverlap(me,o,GAP_PAD)){
        y = o.y + (o.h/2 + H/2 + GAP_PAD + 2); 
        y=Math.min(y,ymax);
      }
    }
    el.style.left=x+'px'; el.style.top=y+'px';
    occupied[i]={x,y,w:W,h:H};
  });
});

function lettersSequenceAboveGift(){
  const wrap=document.getElementById('hbdWrap'); wrap.innerHTML='';
  const gift=document.getElementById('gift'); const r=gift.getBoundingClientRect();
  const topOfLid=r.top + r.height*0.30; const cx=r.left+r.width/2;
  wrap.style.top=(topOfLid-8)+'px'; wrap.style.left=cx+'px'; wrap.style.opacity=1;

  const text='HappyBirthDay', letters=[];
  for(const ch of text){ const s=document.createElement('span'); s.className='hbd-letter'; s.textContent=ch===' ' ? '\u00A0' : ch; wrap.appendChild(s); letters.push(s); }
  letters.forEach((el,i)=>{ el.style.animation=`letterPop .55s cubic-bezier(.2,.9,.2,1) ${i*0.08}s both`; });

  const total=(letters.length-1)*0.08 + 0.55;

  setTimeout(()=>{
    requestAnimationFrame(()=>{  
      requestAnimationFrame(()=>{ 
        const pts=letters.map(el=>{
          const rr=el.getBoundingClientRect();
          return {x:(rr.left+rr.right)/2, y:(rr.top+rr.bottom)/2};
        });
        fireworks(pts,900);
        wrap.animate([{opacity:1},{opacity:0}],{duration:700,delay:400,fill:'forwards'});
        setTimeout(()=>{ wrap.innerHTML=''; },1200);
      });
    });
  }, total*1000);
}

function fireworks(points, duration=600){
  const c=document.getElementById('fireworks'),ctx=c.getContext('2d'); const dpr=Math.min(devicePixelRatio||1,2);
  c.width=innerWidth*dpr; c.height=innerHeight*dpr; ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
  const cols=['#ff7d9b','#ffd166','#8a7bff','#22d3ee','#51ffcd','#fff']; const parts=[];
  points.forEach(p=>{for(let i=0;i<70;i++){const a=Math.random()*Math.PI*2,s=3+Math.random()*5;parts.push({x:p.x,y:p.y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:0,col:cols[i%cols.length]});}});
  const t0=performance.now(); (function tick(t){ ctx.clearRect(0,0,innerWidth,innerHeight);
    parts.forEach(pt=>{pt.life+=1;pt.x+=pt.vx;pt.y+=pt.vy;pt.vy+=0.06;ctx.globalAlpha=Math.max(0,1-pt.life/60);ctx.fillStyle=pt.col;ctx.fillRect(pt.x,pt.y,2.2,2.2);});
    ctx.globalAlpha=1; if(t-t0<duration) requestAnimationFrame(tick); else ctx.clearRect(0,0,innerWidth,innerHeight);
  })(t0);
}


function openBurstFx(origin, mini=false){
  const ring=document.createElement('div'); ring.className='ring'; ring.style.left=origin.x+'px'; ring.style.top=origin.y+'px';
  document.body.appendChild(ring); setTimeout(()=>ring.remove(),1200);
  const left=document.createElement('div'), right=document.createElement('div');
  left.className='banner'; right.className='banner';
  const len=(mini?260:Math.min(380,innerWidth*0.32));
  const r=document.getElementById('gift').getBoundingClientRect(); const h=r.top+26;
  Object.assign(left.style,{left:(origin.x)+'px',top:h+'px',width:'0px',transform:'scaleX(0.001)'}); Object.assign(right.style,{left:(origin.x)+'px',top:(h+14)+'px',width:'0px',transformOrigin:'right center',transform:'scaleX(0.001)'});
  document.body.append(left,right);
  left.animate([{transform:'scaleX(0.001)'},{transform:`scaleX(${len/10})`}],{duration:(mini?720:900),easing:'cubic-bezier(.2,.9,.2,1)',fill:'forwards'});
  right.animate([{transform:'scaleX(0.001)'},{transform:`scaleX(${len/10})`}],{duration:(mini?720:900),easing:'cubic-bezier(.2,.9,.2,1)',fill:'forwards',delay:70});
  setTimeout(()=>{ left.remove(); right.remove(); }, (mini?900:1100));
  const pieces=mini?16:26;
  for(let i=0;i<pieces;i++){
    const p=document.createElement('div'); p.className='ribbon-piece'; p.style.left=origin.x+'px'; p.style.top=origin.y+'px'; document.body.appendChild(p);
    const ang=Math.random()*Math.PI*2, spd=(mini?170:210)+Math.random()*190, dx=Math.cos(ang)*spd, dy=Math.sin(ang)*spd*0.85, rot=(Math.random()*360)|0;
    p.animate([{transform:`translate(0,0) rotate(${rot}deg)`,opacity:1},{transform:`translate(${dx}px,${dy}px) rotate(${rot+360}deg)`,opacity:0}],{duration:(mini?850:1000)+Math.random()*300,easing:'cubic-bezier(.2,.8,.25,1)',fill:'forwards'});
    setTimeout(()=>p.remove(),1400);
  }
}

let finaleDone=false, emptyStreak=0, emptyReset=null; let heatLevel=0;
function updatePreflash(){
  const pf=document.getElementById('preflash');
  pf.style.opacity=String(Math.min(1,0.13*heatLevel));
  const gift=document.getElementById('gift');
  gift.animate([{transform:'translateY(0)'},{transform:`translateY(-${Math.min(6,heatLevel)}px)`},{transform:'translateY(0)'}],{duration:260,easing:'ease-in-out'});
}
function encourage(){
  const msgs=[
    "Click n·ªØa ƒëi! üöÄ","ƒê·ª´ng d·ª´ng l·∫°i ‚ú®","S·∫Øp c√≥ ƒëi·ªÅu b·∫•t ng·ªù‚Ä¶","Ti·∫øp t·ª•c nh√©!","G·∫ßn r·ªìi ƒë√≥! üí´","Ti·∫øp t·ª•c n√†o!","H√© l·ªô s·∫Øp xu·∫•t hi·ªán‚Ä¶"
  ];
  const i=Math.min(emptyStreak, msgs.length-1);
  document.getElementById('remainTxt').textContent=msgs[i];
}
function explodeGift(){
  if(finaleDone) return; finaleDone=true;
  const gift=document.getElementById('gift'); const r=gift.getBoundingClientRect(); const cx=r.left+r.width/2, cy=r.top+r.height/2;
  const flash=document.createElement('div'); flash.className='flash'; document.body.appendChild(flash); flash.style.animation='flashAnim 780ms ease-out forwards'; setTimeout(()=>flash.remove(),820);
  const shock=document.createElement('div'); shock.className='shock'; document.body.appendChild(shock); setTimeout(()=>shock.remove(),1600);
  for(let i=0;i<42;i++){ const f=document.createElement('div'); f.className='frag'; f.style.left=cx+'px'; f.style.top=cy+'px'; document.body.appendChild(f);
    const ang=Math.random()*Math.PI*2, dist=110+Math.random()*260, dx=Math.cos(ang)*dist, dy=Math.sin(ang)*dist;
    f.animate([{transform:'translate(-50%,-50%) rotate(0deg)',opacity:1},{transform:`translate(${dx}px,${dy}px) rotate(${360+Math.random()*360}deg)`,opacity:0}],{duration:1200+Math.random()*600,easing:'cubic-bezier(.2,.9,.2,1)',fill:'forwards'});
    setTimeout(()=>f.remove(),1900);
  }
  gift.style.transition='opacity .25s ease, transform .25s ease'; gift.style.opacity='0'; gift.style.transform='scale(.92) translateY(8px)'; setTimeout(()=>gift.style.display='none',300);
  setTimeout(showLetter,1000);
}
function showLetter(){
  const overlay=document.getElementById('letterOverlay'); const card=document.getElementById('letter');
  overlay.style.display='grid';
  card.animate([{opacity:0, transform:'translateY(20px) scale(.98)'},{opacity:1, transform:'translateY(0) scale(1)'}],{duration:520,easing:'cubic-bezier(.2,.9,.2,1)',fill:'forwards'});
  document.getElementById('closeLetter').onclick=()=>{ overlay.animate([{opacity:1},{opacity:0}],{duration:320,fill:'forwards'}); setTimeout(()=>overlay.style.display='none',340); };
}

/* ===== Click flow ===== */
const giftEl=document.getElementById('gift');
let firstPlayed=false, cooling=false;
function mouthXY(){ const r=giftEl.getBoundingClientRect(); return {x:r.left+r.width/2,y:r.top+r.height*0.56}; }
giftEl.addEventListener('click', ()=>{
  if(cooling || finaleDone) return; cooling=true; setTimeout(()=>cooling=false,240);
  const pos=mouthXY();
  if(!firstPlayed){
    firstPlayed=true; giftEl.classList.add('opened');
    openBurstFx(pos,false); runConfetti(pos,70); lettersSequenceAboveGift(); return;
  }
  if(remaining>0){
    openBurstFx(pos,true); releaseOnePhoto(pos.x,pos.y);
    emptyStreak=0; clearTimeout(emptyReset); emptyReset=null; heatLevel=0; updatePreflash(); updateRemain();
  }else{
    heatLevel=Math.min(10,heatLevel+0.8); updatePreflash(); openBurstFx(pos,true);
    giftEl.querySelector('.lid').animate([{transform:'rotateX(60deg) translateY(-10px)'},{transform:'rotateX(60deg) translateY(-10px) translateX(-6px)'},{transform:'rotateX(60deg) translateY(-10px) translateX(6px)'},{transform:'rotateX(60deg) translateY(-10px)'}],{duration:520,easing:'ease-in-out'});
    emptyStreak++; encourage();
    if(emptyReset) clearTimeout(emptyReset);
    emptyReset=setTimeout(()=>{ emptyStreak=0; heatLevel=0; updatePreflash(); updateRemain(); },2000);
    if(emptyStreak>=10){ explodeGift(); }
  }
});

/* ===== Boot ===== */
(async ()=>{
  IMAGES=await loadUserImages();
  nextIdx=0; remaining=IMAGES.length;
  updateRemain();
})();
</script>
</body>
</html>
